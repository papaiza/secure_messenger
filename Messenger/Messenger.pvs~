
Messenger: THEORY
BEGIN
  delta: posreal % sampling time
  IMPORTING Time[delta]
  i: VAR DTIME
 %Constants
  n: posnat    % maximum number of id's
  max: posreal % maximum balance allowed
% Types
  U_ID : TYPE = {id : posnat | id <= n} CONTAINING 1
    % set of account id's
  M_ID: TYPE = {id : posnat | id <= n} CONTAINING 1
  G_ID:  TYPE = {id : posnat | id <= n} CONTAINING 1
  STATUS   : TYPE = {ok, error}
  NAME: TYPE+
  TEXT: TYPE+
  id : VAR ACC_ID

% Monitored Events
  COMMAND : DATATYPE
    BEGIN
      add_user(id:U_ID, n: NAME)			:add_user?
      add_group(id:G_ID,n: NAME)			:add_group?
      register_user(uid:U_ID,gid:G_ID)			:register_user?
      send_message(uid:U_ID,gid:G_ID,txt:TEXT)		:send_message?
      read_message(uid:U_ID,mid:M_ID)			:read_message?
      delete_message(uid:U_ID,mid:M_ID)			:delete_message?
      set_message_preview(n:INTEGER)			:set_message_preview?
      list_new_messages(uid:U_ID)			:list_new_messages?
      list_old_messages(uid:U_ID)			:list_old_messages?
      list_groups					:list_groups?
      list_users					:list_users?
    END COMMAND
  cmd: VAR [POS_DTIME -> COMMAND]

% Abstract state using a record with dependent typing
  STATE: TYPE =
    [# user_ids	    : set[U_ID]      % Accounts
      ,group_ids    : set[G_ID] % Names
      ,message_ids  : set[M_ID]
      ,user	    : [(user_ids) -> NAME]
      ,group	    : [(group_ids) -> [set[U_ID,NAME]]
      ,message	    : [[message_ids] -> [U_ID,G_ID,set[U_ID],set[U_ID],TEXT]] 	    
    #]
    
  st : VAR [ DTIME -> STATE ]

  % Definition of an empty function
  emptyfun [T, U : TYPE] (x : {x : T | FALSE}) : RECURSIVE U = 
    emptyfun(x) 
    MEASURE (LAMBDA (x : {x : T | FALSE}): 1) 

  init_state: STATE = 
   (# user_ids 	    := emptyset
    , group_ids	    := emptyset 
    , message_ids   := emptyset
    , user 	    := emptyfun
    , group 	    := emptyfun
    , message 	    := emptyfun
    #)

    add_user_ft(id:U_ID,n:NAME)(st)(i:POS_DTIME): bool = 
    	COND
		id > 0 ->
		   COND
			NOT st(i-1)`user_ids(id) ->
			    st(i) = (# user_ids := add(id, user_ids_),
			    	       user := user_ WITH [id := n]
				     #),
			st(i-1)`user_ids(id) -> st(i) = st(i-1)
		   ENDCOND
		id <= 0 -> st(i) = st(i-1)
	ENDCOND
	where
		user_ids_ = st(i-1)`user_ids,
		user_ = st(i-1)`user

    add_group_ft(id:U_ID,n:NAME)(st)(i:POS_DTIME): bool = 
    	COND
		id > 0 ->
		   COND
			NOT st(i-1)`group_ids(id) ->
			    st(i) = (# group_ids := add(id, group_ids_),
			    	       group := group_ WITH [id := [emptyset,n]]
				     #),
			st(i-1)`group_ids(id) -> st(i) = st(i-1)
		   ENDCOND
		id <= 0 -> st(i) = st(i-1)
	ENDCOND
	where
		group_ids_ = st(i-1)`group_ids,
		group_ = st(i-1)`group

    register_user_ft(uid:U_ID,gid:G_ID)(st)(i:POS_DTIME): bool = 
    	COND
		st(i-1)`user_ids(uid) AND st(i-1)`group_ids(gid) AND THIS USER DOESNT ALREADY BELONG TO THIS GROUP->
				     COND
					st(i) = (# group := group_ WITH [gid := [add(uid,old_set_users),old_name]] #)
				     ENDCOND
		NOT(st(i-1)`user_ids(id) AND st(i-1)`group_ids(id)) -> st(i) = st(i-1)		
	ENDCOND
	where
		user_ids_ = st(i-1)`user_ids,
		


    send_message_ft(id:U_ID,n:NAME)(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    delete_message_ft(id:U_ID,n:NAME)(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    set_message_preview_ft(id:U_ID,n:NAME)(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    list_new_messages(id:U_ID)(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    list_old_messages(id:U_ID)(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    list_groups(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

    list_users(st)(i:POS_DTIME): bool = 
    	COND

	ENDCOND

  % domain restriction
  SET_ID : TYPE+ = set[ACC_ID]

  messenger_ft(cmd) (st)(i) : bool =
    COND
      i = 0 -> st(0) = init_state,
      i > 0 -> 
        CASES cmd(i) OF
	   add_user(uid,n)		:	add_user_ft(id,n)(st)(i),
	   add_group(gid,n)		:	add_group_ft(id,n)(st)(i),
    	   register_user(uid,gid)	:	register_user_ft(uid,gid)(st)(i),
    	   send_message(uid,gid,txt)	:	send_message_ft(uid,gid,txt)(st)(i),
           read_message(uid,mid)	:	read_message_ft(uid,mid)(st)(i),
      	   delete_message(uid,mid)	:	delete_message_ft(uid,mid)(st)(i),
      	   set_message_preview(n)	:	set_message_preview(n)(st)(i),
	   list_new_messages(uid)	:	list_new_messages(uid)(st)(i),
	   list_old_messages(uid)	:	list_old_messages(uid)(st)(i),
	   list_groups			:	list_groups(st)(i),
	   list_users			:	list_users(st)(i)
        ENDCASES
    ENDCOND

END Messenger
